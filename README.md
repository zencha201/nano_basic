# nano_basic
Tiny Basic風のBASIC言語インタプリタ。

## 特徴

* シンプルでポータブル
* 環境ごとの命令を追加しやすいように作成する
* REPLのコンソール部分は環境依存コードとして外だし
* 環境によって、ゲーム用機能、組み込みポート機能などを実装する

## 想定環境

* PC (Windows or Linux)
* 組み込みボード(Raspberry Pi Pico)
* Web Assembly (ブラウザやスマホ)
* レトロゲーム機

## メモリ空間使用

データ構造は、行番号、行サイズ、データ

 メモリ空間使用
 コードと変数、スタックは同一のメモリ領域内を区切って使用する

 ----------------
 コード領域
 ----------------
 変数領域
 ----------------
 スタック領域
 ----------------
    
## 変数仕様
  
* 数値のみ（16bit整数）
* A～Z、@の27個の変数
* 配列アクセス: A(n) は変数の n 番目を指す
  - A(0) = A, A(1) = B, ..., A(25) = Z, A(26) = @
* @は配列専用のインデックス変数として使用可能

## モジュール構成

include/

| ファイル名 / モジュール名 | 機能 | 備考 |
|:--|:--|:--|
| include/nano_basic.h | 外部公開定義 ||
| lib/libnanobasic.so|Linux環境向けのライブラリ||
| src/nano_basic_local.h| 内部定義||
| src/interpreter.c|インタプリタ処理 (ループの1順を処理)||
| src/memory.c|メモリ空間管理。コード領域、変数領域、スタック領域を管理。||
| src/calc.c|演算処理、変数処理。||
| src/command.c|コマンド処理を管理。||
| src/debug.c|デバッグ機能 (メモリビューアとか)||
| test/console.c|PC環境用のコンソールコード|他の環境で動かす場合は置き換える。|
| test/test_*|モジュールごとのテストコード||
| test/test.h|テスト関係の定義||

## コマンド

| コマンド名 | 機能 | 備考 |
|:--|:--|:--|
| HELP | コマンド一覧を表示 |  |
| REM 任意 | 注釈 |  |
| LET 変数 数式 | 変数に計算結果を代入する。 |  |
| PRINT 文字列 or 数式[ 文字列 or 数式...] | 文字列または数式の演算結果を出力する。 |  |
| INPUT 変数 | 数値を入力して変数にセットする。 |  |
| IF 数式 処理 | 条件式が真ならば、続く処理を実行する。 |  |
| GOTO 数式 | 数式の演算結果の行に移動する。 |  |
| GOSUB 数式 | 数式の演算結果の行のサブルーチンに移動する。 |  |
| RETURN | サブルーチンから戻る。 |  |
| END | プログラムを終了する。 |  |
| THEN | IFコマンドと組み合わせて使用 | IF文の後に使用可能 |
| RUN [数式] | プログラムを実行する。数式が指定されている場合、演算結果の行から実行する。 |  |
| NEW | プログラムを新規作成する。 |  |
| LOAD [文字列]| プログラムを読み込む。 文字列が指定されていなければ、FILE.BASをファイル名として扱う。ファイル名に"は付けないこと。 |  |
| SAVE [文字列]| プログラムを保存する。 文字列が指定されていなければ、FILE.BASをファイル名として扱う。ファイル名に"は付けないこと。 |  |
| RENUM 数式 [数式]| 行番号を振り直す。第1引数は開始行番号、第2引数（省略可）はステップ数。 |  |
| LIST [数式 [数式]] | プログラムのリストを表示する。引数なし：全行、1引数：指定行のみ、2引数：範囲指定。 |  |
| DEL 数式 [数式] | プログラムの行を削除する。1引数：指定行のみ、2引数：範囲指定。 |  |

## 関数

T.B.D

## ビルド方法

```bash
# 通常のビルド（リリースビルド）
make

# デバッグビルド
make BUILD=debug

# リリースビルド
make BUILD=release

# ライブラリのみビルド
make all

# 実行
make run

# クリーン
make clean
```

## テスト実行方法

```bash
# 全テスト実行
make test_all

# 個別テスト実行
make test_memory      # メモリ管理のテスト
make test_util        # ユーティリティ関数のテスト
make test_calc        # 計算機能のテスト
make test_command     # コマンド機能のテスト
make test_interpreter # インタプリタのテスト
```

## 静的解析

```bash
# cppcheckによる静的解析を実行
make sa
```

静的解析は`cppcheck`を使用します。インストールされていない場合は自動的にインストールされます。解析結果は`static_analysis_report.txt`に出力されます。

## テストカバレッジ

| モジュール | テストファイル | 主なテスト内容 |
|:--|:--|:--|
| src/memory.c | test/test_memory.c | メモリ管理、コード/変数/スタック操作 |
| src/util.c | test/test_util.c | 文字列操作、メモリ操作 |
| src/calc.c | test/test_calc.c | 四則演算、比較演算、論理演算、変数参照 |
| src/command.c | test/test_command.c | BASIC言語コマンドの実行 |
| src/interpreter.c | test/test_interpreter.c | コード解析、コマンド実行制御 |

# nano basicの使い方

別のGithubリポジトリから使用する場合は、submoduleでリンクさせる

